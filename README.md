# Документация проекта

Этот репозиторий содержит набор утилит для обработки веб‑хуков из сервиса «Мой склад».
Основная логика реализована на Python, приём веб‑хуков осуществляется скриптом `trap.php`.

## Структура каталогов

- `echo/` – основной модуль на Python.
  - `config.py` – таблица скидок и строки для статусов/галок.
  - `main.py` – точка входа. Читает файл вебхука и запускает очередь событий.
  - `classes/` – вспомогательные классы и функции.
    - `checker.py` – обработка счёта, формирование `big_data` со всеми параметрами.
    - `judge.py` – принимает решения на основе `big_data`, меняет статусы и сбрасывает галочки через API.
    - `my_queue.py` – очередь событий из вебхука; создаёт `Checker` и `Judge` для каждого события.
    - `dir_master.py` – утилиты для работы с директориями и файлами.
    - `mymslib.py` – клиент для API «Мой склад».
    - `super_event_worker.py`, `tovaroved.py` – альтернативные/черновые модули обработки.
  - `webhooks/` – сюда попадают принятые веб‑хуки (файлы JSON).
  - `temp/` – временные файлы.
  - `trap.php` – php‑скрипт для приёма веб‑хука и запуска `main.py`.
- `logus/` – директория для логов.
- `casa/` – пустой каталог‑заготовка.

## Основные компоненты

### APIClient (`classes/mymslib.py`)

Класс `APIClient` инкапсулирует работу с HTTP API «Мой склад». Поддерживает методы `get`, `put`, `post`,
а также удобные функции `mass_zapros` и `get_invoiceout`. На этапе инициализации формируются заголовки
авторизации; также есть проверка `_test_headers` для подтверждения корректности логина и пароля.

### Queue (`classes/my_queue.py`)

Класс `Queue` отвечает за последовательную обработку событий из вебхука. После загрузки всех событий
из `audit_href`, для каждого создаётся директория, сохраняется JSON события, затем в зависимости от типа
документа запускается `Checker` и `Judge`.

### Checker (`classes/checker.py`)

Получает подробные данные счёта, вычисляет сумму, скидки, текущий статус и выставленные галочки.
Результаты сохраняются в словаре `big_data`, который затем передаётся `Judge`.

### Judge (`classes/judge.py`)

Использует `big_data` для принятия решения о том, какой статус установить документу и какие галочки
сбросить. Содержит набор методов `st_*` и `fs_*` для работы с различными состояниями.

### Главный сценарий (`main.py`)

Инициирует объект `Chulan` для хранения данных обработки. Через `Queue` выполняется последовательная
обработка всех событий. Все логи складываются в `logus/`.

### trap.php

Принимает веб‑хук от внешнего сервиса, сохраняет JSON в `webhooks/` и запускает `main.py`,
передавая имя сохранённого файла.

## Стиль кода

Код написан на Python 3. Используется модуль `logging` (через функцию `get_logger`) с ротацией файлов.
Комментарии и логи преимущественно на русском языке. Для работы с JSON активно применяется библиотека
`jmespath` (функция `rip`).

## Назначение

Проект предназначен для автоматизации обработки счётов в «Мой склад». Веб‑хуки анализируются,
документ переводится в нужный статус, при необходимости сбрасываются галочки согласования.


